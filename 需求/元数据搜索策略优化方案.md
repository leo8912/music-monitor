# å…ƒæ•°æ®æœç´¢ç­–ç•¥ä¼˜åŒ–æ–¹æ¡ˆ

## é—®é¢˜åˆ†æ
æ—¢ç„¶å…ƒæ•°æ®è·å–æ— éœ€å†·å´æœŸï¼Œé‚£ä¹ˆè‡ªåŠ¨è¡¥å…¨å¤±è´¥çš„ä¸»è¦åŸå› å¯èƒ½æ˜¯ï¼š

1. **æœç´¢å…³é”®è¯ä¸å‡†ç¡®** - æ ‡ç‚¹ç¬¦å·ã€ç‰¹æ®Šå­—ç¬¦å¤„ç†ä¸å½“
2. **åŒ¹é…ç®—æ³•ä¸å¤Ÿæ™ºèƒ½** - æ— æ³•å¤„ç†æ­Œæ›²åçš„å˜ä½“å½¢å¼
3. **APIè°ƒç”¨ç­–ç•¥å•ä¸€** - ç¼ºä¹å¤šè½®å°è¯•æœºåˆ¶
4. **é”™è¯¯å¤„ç†ä¸å®Œå–„** - æœªèƒ½å……åˆ†åˆ©ç”¨é‡è¯•æœºä¼š

## ä¼˜åŒ–æ–¹æ¡ˆ

### 1. æ™ºèƒ½å…³é”®è¯é¢„å¤„ç†
```python
def preprocess_search_keywords(title: str, artist: str) -> tuple[str, str]:
    """æ™ºèƒ½é¢„å¤„ç†æœç´¢å…³é”®è¯"""
    
    # æ¸…ç†æ ‡ç‚¹ç¬¦å·å’Œç‰¹æ®Šå­—ç¬¦
    def clean_text(text: str) -> str:
        if not text:
            return ""
        
        # ç§»é™¤å¸¸è§çš„æ ‡ç‚¹ç¬¦å·ï¼Œä½†ä¿ç•™ä¸­æ–‡æ ‡ç‚¹
        import re
        # ä¿ç•™ä¸­è‹±æ–‡ç©ºæ ¼ã€ä¸­æ–‡å­—æ¯æ•°å­—
        cleaned = re.sub(r'[^\w\s\u4e00-\u9fff]', ' ', text)
        # è§„èŒƒåŒ–ç©ºç™½å­—ç¬¦
        cleaned = re.sub(r'\s+', ' ', cleaned).strip()
        return cleaned
    
    # å¤„ç†æ­Œæ›²æ ‡é¢˜
    clean_title = clean_text(title)
    
    # å¤„ç†è‰ºäººåç§°
    clean_artist = clean_text(artist)
    
    # ç‰¹æ®Šå¤„ç†ï¼šæå–æ ¸å¿ƒå…³é”®è¯
    def extract_keywords(text: str) -> str:
        if not text:
            return ""
        
        # åˆ†å‰²å¹¶è¿‡æ»¤åœç”¨è¯
        words = text.split()
        stop_words = {'-', 'â€“', 'â€”', '|', '&', 'and', 'feat', 'ft', 'featuring'}
        filtered_words = [word for word in words if word.lower() not in stop_words]
        
        return ' '.join(filtered_words[:3])  # æœ€å¤šå–å‰3ä¸ªå…³é”®è¯
    
    optimized_title = extract_keywords(clean_title)
    optimized_artist = extract_keywords(clean_artist)
    
    return optimized_title, optimized_artist

# ä½¿ç”¨ç¤ºä¾‹
title, artist = preprocess_search_keywords("å‘¨æ°ä¼¦-ç¨»é¦™(ç”µå½±ç‰ˆ)", "å‘¨æ°ä¼¦/Jay Chou")
# ç»“æœ: title="å‘¨æ°ä¼¦ ç¨»é¦™", artist="å‘¨æ°ä¼¦ Jay Chou"
```

### 2. å¤šè½®æ¸è¿›å¼æœç´¢ç­–ç•¥
```python
async def progressive_metadata_search(self, original_title: str, original_artist: str) -> MetadataResult:
    """å¤šè½®æ¸è¿›å¼æœç´¢ç­–ç•¥"""
    
    # æœç´¢ç­–ç•¥ä¼˜å…ˆçº§
    search_strategies = [
        {
            'name': 'ç²¾ç¡®åŒ¹é…',
            'func': self._exact_search,
            'keywords': (original_title, original_artist),
            'priority': 1
        },
        {
            'name': 'å…³é”®è¯ä¼˜åŒ–',
            'func': self._optimized_search,
            'keywords': preprocess_search_keywords(original_title, original_artist),
            'priority': 2
        },
        {
            'name': 'æ ‡é¢˜å•ç‹¬æœç´¢',
            'func': self._title_only_search,
            'keywords': (original_title, ""),
            'priority': 3
        },
        {
            'name': 'ç®€åŒ–æœç´¢',
            'func': self._simplified_search,
            'keywords': self._get_simplified_keywords(original_title, original_artist),
            'priority': 4
        }
    ]
    
    logger.info(f"ğŸ” å¼€å§‹æ¸è¿›å¼æœç´¢: {original_title} - {original_artist}")
    
    for strategy in search_strategies:
        try:
            logger.info(f"ğŸ¯ å°è¯•ç­–ç•¥ {strategy['priority']}: {strategy['name']}")
            
            result = await strategy['func'](*strategy['keywords'])
            
            if result and result.success:
                logger.info(f"âœ… ç­–ç•¥ {strategy['priority']} æˆåŠŸ: {original_title}")
                return result
            else:
                logger.info(f"â­ï¸ ç­–ç•¥ {strategy['priority']} æœªæ‰¾åˆ°åˆé€‚ç»“æœ")
                
        except Exception as e:
            logger.warning(f"âš ï¸ ç­–ç•¥ {strategy['priority']} å¼‚å¸¸: {e}")
            continue
    
    logger.warning(f"âŒ æ‰€æœ‰æœç´¢ç­–ç•¥å‡å¤±è´¥: {original_title} - {original_artist}")
    return MetadataResult(success=False)

async def _exact_search(self, title: str, artist: str) -> MetadataResult:
    """ç²¾ç¡®æœç´¢"""
    if not title.strip():
        return MetadataResult()
    keyword = f"{title} {artist}".strip()
    return await self._basic_search(keyword)

async def _optimized_search(self, title: str, artist: str) -> MetadataResult:
    """ä¼˜åŒ–å…³é”®è¯æœç´¢"""
    if not title.strip():
        return MetadataResult()
    keyword = f"{title} {artist}".strip()
    return await self._basic_search(keyword)

async def _title_only_search(self, title: str, _) -> MetadataResult:
    """ä»…ä½¿ç”¨æ ‡é¢˜æœç´¢"""
    if not title.strip():
        return MetadataResult()
    return await self._basic_search(title)

async def _simplified_search(self, title: str, artist: str) -> MetadataResult:
    """ç®€åŒ–æœç´¢"""
    # æå–æœ€æ ¸å¿ƒçš„å…³é”®è¯
    main_title = title.split()[0] if title.split() else ""
    main_artist = artist.split()[0] if artist.split() else ""
    
    if main_title:
        keyword = f"{main_title} {main_artist}".strip()
        return await self._basic_search(keyword)
    return MetadataResult()

def _get_simplified_keywords(self, title: str, artist: str) -> tuple[str, str]:
    """è·å–ç®€åŒ–çš„æœç´¢å…³é”®è¯"""
    # åªå–ç¬¬ä¸€ä¸ªè¯
    simple_title = title.split()[0] if title.split() else title
    simple_artist = artist.split()[0] if artist.split() else artist
    return simple_title, simple_artist
```

### 3. å¢å¼ºçš„é”™è¯¯åˆ†ç±»å’Œå¤„ç†
```python
class MetadataSearchError(Exception):
    """å…ƒæ•°æ®æœç´¢é”™è¯¯åŸºç±»"""
    def __init__(self, message: str, error_type: str, retryable: bool = True):
        super().__init__(message)
        self.error_type = error_type
        self.retryable = retryable

def classify_search_error(error: Exception) -> tuple[str, bool]:
    """åˆ†ç±»æœç´¢é”™è¯¯"""
    error_msg = str(error).lower()
    
    if 'timeout' in error_msg or 'timed out' in error_msg:
        return 'timeout', True
    elif 'connection' in error_msg or 'network' in error_msg:
        return 'network_error', True
    elif '404' in error_msg or 'not found' in error_msg:
        return 'not_found', False  # æœç´¢æ— ç»“æœï¼Œä¸é‡è¯•
    elif '429' in error_msg or 'rate limit' in error_msg:
        return 'rate_limit', True
    elif 'json' in error_msg or 'parse' in error_msg:
        return 'parse_error', True
    else:
        return 'unknown', True

@async_retry(max_retries=5, backoff_factor=2, should_retry_func=should_retry_metadata_search)
async def fetch_metadata_enhanced(self, title: str, artist: str) -> MetadataResult:
    """å¢å¼ºç‰ˆå…ƒæ•°æ®è·å–"""
    try:
        result = await self.progressive_metadata_search(title, artist)
        return result
    except Exception as e:
        error_type, retryable = classify_search_error(e)
        logger.warning(f"å…ƒæ•°æ®æœç´¢å¤±è´¥ [{error_type}]: {title} - {artist}")
        raise MetadataSearchError(str(e), error_type, retryable) from e

def should_retry_metadata_search(exception: Exception) -> bool:
    """åˆ¤æ–­æ˜¯å¦åº”è¯¥é‡è¯•å…ƒæ•°æ®æœç´¢"""
    if isinstance(exception, MetadataSearchError):
        return exception.retryable
    return True  # é»˜è®¤é‡è¯•
```

### 4. æˆåŠŸç‡ç›‘æ§å’Œç»Ÿè®¡
```python
class MetadataSuccessTracker:
    """å…ƒæ•°æ®æˆåŠŸç‡è·Ÿè¸ªå™¨"""
    
    def __init__(self):
        self.stats = {
            'total_attempts': 0,
            'successful': 0,
            'failed': 0,
            'by_strategy': {},  # æŒ‰ç­–ç•¥ç»Ÿè®¡
            'by_error_type': {},  # æŒ‰é”™è¯¯ç±»å‹ç»Ÿè®¡
            'recent_success_rate': []  # æœ€è¿‘100æ¬¡çš„æˆåŠŸç‡
        }
    
    async def record_attempt(self, strategy_name: str, success: bool, error_type: str = None):
        """è®°å½•æœç´¢å°è¯•ç»“æœ"""
        self.stats['total_attempts'] += 1
        
        if success:
            self.stats['successful'] += 1
        else:
            self.stats['failed'] += 1
            
        # æŒ‰ç­–ç•¥ç»Ÿè®¡
        if strategy_name not in self.stats['by_strategy']:
            self.stats['by_strategy'][strategy_name] = {'success': 0, 'total': 0}
        self.stats['by_strategy'][strategy_name]['total'] += 1
        if success:
            self.stats['by_strategy'][strategy_name]['success'] += 1
            
        # æŒ‰é”™è¯¯ç±»å‹ç»Ÿè®¡
        if error_type:
            if error_type not in self.stats['by_error_type']:
                self.stats['by_error_type'][error_type] = 0
            self.stats['by_error_type'][error_type] += 1
            
        # æ›´æ–°è¿‘æœŸæˆåŠŸç‡
        self._update_recent_success_rate(success)
        
        # å®šæœŸè¾“å‡ºç»Ÿè®¡
        if self.stats['total_attempts'] % 50 == 0:
            await self._log_statistics()
    
    def _update_recent_success_rate(self, success: bool):
        """æ›´æ–°è¿‘æœŸæˆåŠŸç‡"""
        self.stats['recent_success_rate'].append(1 if success else 0)
        if len(self.stats['recent_success_rate']) > 100:
            self.stats['recent_success_rate'].pop(0)
    
    async def _log_statistics(self):
        """è¾“å‡ºç»Ÿè®¡ä¿¡æ¯"""
        overall_rate = (self.stats['successful'] / self.stats['total_attempts']) * 100
        recent_rate = (sum(self.stats['recent_success_rate']) / len(self.stats['recent_success_rate'])) * 100 if self.stats['recent_success_rate'] else 0
        
        logger.info(f"ğŸ“Š å…ƒæ•°æ®æœç´¢ç»Ÿè®¡ - æ€»å°è¯•: {self.stats['total_attempts']}, "
                   f"æˆåŠŸç‡: {overall_rate:.1f}%, è¿‘æœŸæˆåŠŸç‡: {recent_rate:.1f}%")
        
        # è¾“å‡ºç­–ç•¥æˆåŠŸç‡
        logger.info("ğŸ“ˆ å„ç­–ç•¥æˆåŠŸç‡:")
        for strategy, stats in self.stats['by_strategy'].items():
            rate = (stats['success'] / stats['total']) * 100
            logger.info(f"  {strategy}: {rate:.1f}% ({stats['success']}/{stats['total']})")

# å…¨å±€å®ä¾‹
metadata_tracker = MetadataSuccessTracker()
```

## å®æ–½è®¡åˆ’

### ç¬¬ä¸€é˜¶æ®µï¼šåŸºç¡€ä¼˜åŒ–ï¼ˆ3-5å¤©ï¼‰
1. å®ç°å…³é”®è¯é¢„å¤„ç†åŠŸèƒ½
2. éƒ¨ç½²å¤šè½®æ¸è¿›å¼æœç´¢
3. å¢åŠ è¯¦ç»†çš„æ—¥å¿—è®°å½•

### ç¬¬äºŒé˜¶æ®µï¼šæ™ºèƒ½ä¼˜åŒ–ï¼ˆ1-2å‘¨ï¼‰
1. å®æ–½é”™è¯¯åˆ†ç±»å’Œå·®å¼‚åŒ–å¤„ç†
2. éƒ¨ç½²æˆåŠŸç‡ç›‘æ§ç³»ç»Ÿ
3. ä¼˜åŒ–é‡è¯•ç­–ç•¥

### ç¬¬ä¸‰é˜¶æ®µï¼šæŒç»­æ”¹è¿›ï¼ˆæŒç»­è¿›è¡Œï¼‰
1. åŸºäºç»Ÿè®¡æ•°æ®è°ƒæ•´ç­–ç•¥ä¼˜å…ˆçº§
2. å®æ–½æœºå™¨å­¦ä¹ è¾…åŠ©çš„å…³é”®è¯ä¼˜åŒ–
3. å»ºç«‹A/Bæµ‹è¯•æœºåˆ¶

## é¢„æœŸæ”¶ç›Š

âœ… **æé«˜æˆåŠŸç‡**ï¼šé€šè¿‡å¤šè½®ç­–ç•¥æœç´¢ï¼Œé¢„è®¡æˆåŠŸç‡æå‡30-50%
âœ… **å‡å°‘ç”¨æˆ·å¹²é¢„**ï¼šæ™ºèƒ½é‡è¯•æœºåˆ¶å‡å°‘æ‰‹åŠ¨åˆ®å‰Šéœ€æ±‚
âœ… **å¢å¼ºç³»ç»Ÿé²æ£’æ€§**ï¼šæ›´å¥½çš„é”™è¯¯å¤„ç†å’Œæ¢å¤èƒ½åŠ›
âœ… **æä¾›æ•°æ®æ´å¯Ÿ**ï¼šè¯¦ç»†çš„ç»Ÿè®¡å¸®åŠ©æŒç»­ä¼˜åŒ–