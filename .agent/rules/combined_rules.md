---
trigger: always_on
---

---
trigger: always_on
---

# 项目介绍
这是一个后端。集成了 **多平台音乐监控、自动下载** 的全栈解决方案。它能自动追踪你关注的歌手在 **网易云音乐** 和 **QQ音乐** 的最新发布动态，并通过企业微信即时推送通知，甚至可以直接在网页端播放和收藏。

# 项目开发规则总览
- 我是Windows系统环境，注意命令使用方式
- 每次都先给我建议，确认通过再实施，不要自作主张决定实现方式
- 每次都计划都以md格式放进文档中，开头备注时间
- **配置维护**: 每次发版/提交前，必须检查 `config.example.yaml` 是否包含所有最新的配置项（包括高级选项）。`config.example.yaml` 是配置结构的**唯一真理来源**。所有新增配置必须同步到模板中。
## 1. 代码组织规范
- 每个文件代码、文档都要在开头注释备注下该文件的目的、作用。无法备注的文件要在文件夹下写一个md备注各文件作用。
- 后期修改时也要同步修改备注，加上各文件的更新日志,后缀作者为google
- 测试文件要都放在测试文件夹下，文件夹名测试分门别类
- 文档目录结构要规范清晰
- api和相关稳定等等放在文档文件夹下，文件夹名文档
- 所有需求、todo、修改方案计划、等等都放在需求文件夹下，文件夹名需求


## 当前调用逻辑梳理

### 1. 搜索歌手
- 调用qqmusic-api、pyncm来搜索列表并提供头像、歌手名
- 进行去重处理
- 如本地数据库已有头像、歌手名，优先从本地数据库获取

### 2. 添加歌手后自动搜索歌曲列表
- 调用qqmusic-api、pyncm获取封面、专辑名、发布日期
- 进行去重处理
- 匹配歌手名、歌曲名一致性
- 如本地数据库已有相关数据，优先从本地数据库获取

### 3. 本地歌曲补全数据
- 调用qqmusic-api、pyncm补全元数据并写入数据库
- 补全内容包括：歌手名、歌手头像、歌曲名、封面、歌词、发布日期
- 如本地数据库已有相关数据，优先从本地数据库获取

### 4. 点击播放逻辑
- 优先匹配本地媒体库是否有匹配文件
- 如有匹配，直接本地播放，并将文件路径写入下载历史数据库
- 如无匹配，调用gdstudio搜索下载无损最高音质
- 搜索结果按所有音乐源顺序搜索，匹配最高音质
- 匹配歌手、专辑名一致性并打分
- 直到完全一致停止搜索并开始下载
- 确保不下载翻唱歌曲

### 5、下载逻辑
 - 下载只用gdstudio的api接口，注意5分钟50次的限制频率


目录结构，参考下面要按照功能划分，模块尽量解耦方便维护为目的，不要到处乱放代码乱放文件。
app/services/
├── music_providers/          # 音乐源提供者(新)
│   ├── __init__.py
│   ├── base.py              # 基础抽象类
│   ├── netease_provider.py  # 网易云提供者(pyncm同步→异步)
│   ├── qqmusic_provider.py  # QQ音乐提供者(qqmusic-api同步→异步)
│   └── aggregator.py        # 聚合器(并发调用+打分去重)
│

## 6. 技能调用规范 (Mandatory Skills)
**强制执行**:
在进行任何代码修改、重构或新功能开发时，**必须**首先参考并遵循 `music-monitor-dev` 技能中的架构模式与 UI 规范。
- 遇到架构决策 -> 查看 `music-monitor-dev` -> 1. Project Architecture
- 遇到前端开发 -> 查看 `music-monitor-dev` -> 2. Frontend UI Standards
- 涉及 GDStudio API -> 查看 `music-monitor-dev` -> 6. GDStudio API Reference (需定期通过 tests/sync_gdstudio_skill.py 验证并一键同步更新稳定性信息至 Skill)
