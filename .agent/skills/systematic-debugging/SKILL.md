---
name: systematic-debugging
description: 当遇到任何 Bug、测试失败或意外行为时，在提出修复建议之前务必使用此技能。
trigger: 触发词: [调试, Debug, 修复BUG, 排错, 故障诊断]
---

# 系统化调试 (Systematic Debugging)

## 概述

随机的修复会浪费时间并制造新的 Bug。快速补丁往往只能掩盖底层问题。

**核心原则**：在尝试修复之前，必须先找到**根本原因 (Root Cause)**。只修复症状就是失败。

**违反此流程就是违反调试精神。**

## 铁律 (The Iron Law)

```
先查根因，再谈修复 (NO FIXES WITHOUT ROOT CAUSE INVESTIGATION FIRST)
```

如果你没有完成第一阶段，你就不能提出修复方案。

## 适用场景

适用于任何技术问题：
- 测试失败
- 生产环境 Bug
- 意外行为
- 性能问题
- 构建失败
- 集成问题

**特别是在以下情况时必须使用：**
- 时间紧迫（紧急情况容易让人想去“猜”）。
- “只需一个小修补”看起来很明显。
- 你已经尝试了多种修复方法。
- 之前的修复不起作用。
- 你不完全理解这个问题。

## 四个阶段 (The Four Phases)

你必须在进入下一阶段前完成当前阶段。

### 第一阶段：根因调查 (Phase 1: Root Cause Investigation)

**在尝试任何修复之前：**

1.  **仔细阅读错误信息**
    - 不要跳过错误或警告。
    - 它们通常包含确切的解决方案。
    - 完整阅读堆栈跟踪 (Stack Trace)。
    - 记录行号、文件路径、错误代码。

2.  **稳定复现**
    - 你能可靠地触发它吗？
    - 确切步骤是什么？
    - 每次都发生吗？
    - 如果不能复现 → 收集更多数据，不要猜。

3.  **检查最近的更改**
    - 有什么变化导致了这个问题？
    - Git diff，最近的提交。
    - 新依赖，配置更改。
    - 环境差异。

4.  **追踪数据流**
    - 坏值从哪里来？
    - 什么调用了它？
    - 向上追踪直到找到源头。
    - 在源头修复，而不是在症状处修复。

### 第二阶段：模式分析 (Phase 2: Pattern Analysis)

**在修复之前找到模式：**

1.  **寻找工作案例**
    - 在同一代码库中找到类似且能正常工作的代码。
    - 有什么相似之处是有效的？

2.  **对比差异**
    - 工作代码和损坏代码有什么区别？
    - 列出每一个区别，无论多小。
    - 不要假设“那无关紧要”。

3.  **理解依赖**
    - 它需要什么其他组件？
    - 配置、环境设置？
    - 它做了什么假设？

### 第三阶段：假设与测试 (Phase 3: Hypothesis and Testing)

**科学方法：**

1.  **提出单一假设**
    - 清楚地陈述：“我认为 X 是根本原因，因为 Y”。
    - 写下来。
    - 具体，不要模糊。

2.  **最小化测试**
    - 做最小的改动来测试假设。
    - 一次只变一个变量。
    - 不要一次修复多件事。

3.  **验证后继续**
    - 有用吗？是 → 第四阶段。
    - 没用？提出新假设。
    - **不要**在无效的修复上叠加新修复。

### 第四阶段：实施 (Phase 4: Implementation)

**修复根本原因，而不是症状：**

1.  **创建失败的测试用例**
    - 最简单的复现脚本。
    - 尽可能自动化。
    - **必须在修复前拥有它**。
    - 使用 `test-driven-development` 技能编写测试。

2.  **实施单一修复**
    - 解决确定的根本原因。
    - 一次一个改动。
    - 不要夹带私货（重构、优化）。

3.  **验证修复**
    - 测试通过了吗？
    - 没有破坏其他测试吗？
    - 问题真的解决了吗？

4.  **如果修复无效**
    - 停止 (STOP)。
    - 计数：你试过几种修复了？
    - 如果 < 3：返回第一阶段，重新分析。
    - **如果 ≥ 3：停止并质疑架构 (见下文)**。

## 危险信号 - 立即停止并遵循流程

如果你发现自己在想：
- “先快速修一下，以后再调查”
- “试着改一下 X 看看行不行”
- “一次改好几个地方，然后跑测试”
- “跳过测试，我会手动验证”
- “大概是 X，我修修看”
- “我不太懂，但这可能有用”
- “再试一次修复” (已经失败了2次以上)

**所有这些都意味着：停止。返回第一阶段。**
